"use strict";!function(){function buildTeamList(response){$loadingSpan.remove(),$(".error").remove();var $alphabeticallySortedTeams=response.sort(function(a,b){var nameA=a.team_name.toLowerCase(),nameB=b.team_name.toLowerCase();return nameA<nameB?-1:nameA>nameB?1:0}).map(function(team){return $("<option/>").attr("data-team-id",team.team_id).text(""+team.team_name)});$("body").prepend($("<p/>").attr("id","teamsSection").text("Team: ").append($("<select/>").attr("id","teams").append($alphabeticallySortedTeams))),$("#teams").select2(),$("#teamsSection .select2").after($("<button/>").attr("id","teambutton").text("Go")),$("#teambutton").click(function(){$("#teamsSection").nextAll().remove(),$(".error").remove(),window.soccer.teamNameForResults=$("#teams :selected").val();var teamId=window.soccer.teamIdForResults=$("#teams :selected").data("team-id"),$teamButton=$("#teambutton").attr("disabled","disabled").after($loadingSpan);fetch("http://api.football-api.com/2.0/matches?comp_id=1204&team_id="+teamId+"&from_date=20160812&to_date=20170531&Authorization="+API_KEY).then(function(response){return response.json()}).then(function(response){$teamButton.removeAttr("disabled"),$loadingSpan.remove(),buildGameList(response)}).catch(showError)})}function buildGameList(response){window.soccer.matchesReponse=response;var $dateSortedGames=response.sort(function(a,b){return dottedDateStringToDate(a.formatted_date)-dottedDateStringToDate(b.formatted_date)}).map(function(game){var isHomeTeam=game.localteam_id==window.soccer.teamIdForResults,firstTeamName=isHomeTeam?game.localteam_name:game.visitorteam_name,secondTeamName=isHomeTeam?game.visitorteam_name:game.localteam_name,$option=$("<option/>").attr("data-game-id",game.id).text(printPrettyDate(game.formatted_date)+": "+firstTeamName+" vs. "+secondTeamName);return/\[\-\]/.test(game.ft_score)&&$option.attr("disabled","disabled"),$option});$("#teamsSection").after($("<p/>").attr("id","gamesSection").text("Game: ").append($("<select/>").attr("id","games").append($dateSortedGames)));var $mostRecentGame=$("#games option:not([disabled])").last();$("#games").val($mostRecentGame.val()),$("#games").select2(),$("#gamesSection .select2").after($("<button/>").attr("id","gamebutton").text("Go")),$("#gamebutton").click(function(){$("#gamesSection").nextAll().remove(),$(".error").remove();var gameId=$("#games :selected").data("game-id"),$gameButton=$("#gamebutton").attr("disabled","disabled").after($loadingSpan);fetch("http://api.football-api.com/2.0/commentaries/"+gameId+"?Authorization="+API_KEY).then(function(response){return response.json()}).then(function(response){$gameButton.removeAttr("disabled"),$loadingSpan.remove(),buildTable(response)}).catch(showError)})}function buildTable(gameCommentaryJson){var teamIdForResults=soccer.teamIdForResults,gameId=gameCommentaryJson.match_id,gameStatsJson=soccer.matchesReponse.find(function(game){return game.id==gameId}),isHomeTeam=gameStatsJson.localteam_id==teamIdForResults,gameResult=gameStatsJson.localteam_score==gameStatsJson.visitorteam_score?"D":void 0,goalsScored=gameStatsJson[isHomeTeam?"localteam_score":"visitorteam_score"],goalsAllowed=gameStatsJson[isHomeTeam?"visitorteam_score":"localteam_score"],gameCommentaryStatsJson=gameCommentaryJson.match_stats[isHomeTeam?"localteam":"visitorteam"][0],shotsOnGoal=gameCommentaryStatsJson.shots_ongoal,firstGoalEvent=gameStatsJson.events.find(function(event){return"goal"==event.type}),hadFirstGoal=!!firstGoalEvent&&firstGoalEvent.team==(isHomeTeam?"localteam":"visitorteam"),saves=gameCommentaryStatsJson.saves,numOfUnsuccessfulPks=gameStatsJson.events.filter(function(event){return"pen miss"==event.type&&event.team==(isHomeTeam?"visitorteam":"localteam")}).length,yellowCards=gameCommentaryStatsJson.yellowcards,redCards=gameCommentaryStatsJson.redcards;gameResult||(gameResult=isHomeTeam?gameStatsJson.localteam_score>gameStatsJson.visitorteam_score?"W":"L":gameStatsJson.localteam_score<gameStatsJson.visitorteam_score?"W":"L");var gameResultPoints="W"==gameResult?5:"D"==gameResult?2:0,goalsScoredPoints=2*goalsScored,goalsAllowedPoints=0==goalsAllowed?4:1==goalsAllowed?2:2==goalsAllowed?0:3==goalsAllowed?-2:-4,shotsOnGoalPoints=.25*shotsOnGoal,hadFirstGoalPoints=hadFirstGoal?1:0,savesPoints=1*saves,yellowCardsPoints=yellowCards*-1,redCardsPoints=redCards*-2,totalPoints=gameResultPoints+goalsScoredPoints+goalsAllowedPoints+shotsOnGoalPoints+hadFirstGoalPoints+savesPoints+yellowCardsPoints+redCardsPoints,results={gameResult:gameResult,gameResultPoints:gameResultPoints,goalsScored:goalsScored,goalsScoredPoints:goalsScoredPoints,goalsAllowed:goalsAllowed,goalsAllowedPoints:goalsAllowedPoints,shotsOnGoal:shotsOnGoal,shotsOnGoalPoints:shotsOnGoalPoints,hadFirstGoal:hadFirstGoal,hadFirstGoalPoints:hadFirstGoalPoints,saves:saves,savesPoints:savesPoints,yellowCards:yellowCards,yellowCardsPoints:yellowCardsPoints,redCards:redCards,redCardsPoints:redCardsPoints,numOfUnsuccessfulPks:numOfUnsuccessfulPks,totalPoints:totalPoints},tableTemplate=_.template($("#resultsTableTemplate").html());if($("p").last().after(tableTemplate(results)),numOfUnsuccessfulPks){var pkSavesCommentary=gameCommentaryJson.comments.filter(function(comment){var lowerCaseComment=comment.comment.toLowerCase();return lowerCaseComment.indexOf("pk")!==-1||lowerCaseComment.indexOf("penalty")!==-1}).reverse().map(function(comment){return{minute:comment.minute,comment:comment.comment}}),pkSavesCommentaryHtml=pkSavesCommentary.reduce(function(prev,curr){return prev+"<strong>"+curr.minute+":</strong> "+curr.comment+"<br><br>"},"");$("#pkSaves").prepend($("<input/>").attr({id:"pkSavesInput",type:"text",maxlength:2})),$("#results").after($("<p/>").attr("id","pkSavesExplanation").html("It looks like there "+(numOfUnsuccessfulPks>1?"were":"was")+" <strong>"+numOfUnsuccessfulPks+"</strong> unsuccessful "+(numOfUnsuccessfulPks>1?"PK attempts":"PK attempt")+" in this game, but this tool can't tell if "+(numOfUnsuccessfulPks>1?"they were":"it was")+" saved by the keeper or "+(numOfUnsuccessfulPks>1?"were":"was")+" simply "+(numOfUnsuccessfulPks>1?"misses":"a miss")+'. Take a look below at the commentary from the game that contains "PK" or "penalty" to figure out how many PKs the '+window.soccer.teamNameForResults+" keeper saved, and enter that number in the PK Saves box above.")),$("#pkSavesExplanation").after($("<p/>").attr("id","pkSavesCommentary").html(pkSavesCommentaryHtml)),$("#pkSavesInput").on("input",function(){var inputtedPkSavesValue=$(this).val(),pkSavesPoints=2*inputtedPkSavesValue;$("#pkSavesPoints").text(pkSavesPoints),$("#results").nextAll().remove(),showTotal(totalPoints+pkSavesPoints)})}else showTotal(totalPoints)}function printPrettyDate(dottedDateString){return dottedDateStringToDate(dottedDateString).toDateString()}function dottedDateStringToDate(dottedDateString){var m=dottedDateString.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);return new Date(m[3],m[2]-1,m[1])}function showTotal(totalPoints){$("#results").after($("<p/>").attr("id","total").addClass("code").text("Total points: "+totalPoints))}function showError(e){throw $("body").prepend($("<p/>").addClass("error").text("Uh oh... looks like something went wrong. Details: ").append($("<span/>").addClass("code").text(e))),e}var API_KEY="565ec012251f932ea4000001cafc2a100a034ce6614e2d2c36138196";window.soccer={};var $loadingSpan;$(function(){$loadingSpan=$("<span/>").addClass("loading").text("Loading..."),$("body").append($loadingSpan),fetch("http://api.football-api.com/2.0/standings/1204?Authorization="+API_KEY).then(function(response){return response.json()}).then(buildTeamList).catch(showError)})}();